<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>「崩坏：星穹铁道」三月七主题 - 音乐可视化播放器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a0a2e, #2d0b4b);
            color: #e9e3ff;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            position: relative;
            cursor: default;
        }
        
        #bgOverlay {
            position: fixed;
            top: -10%;
            left: -10%;
            width: 120%;
            height: 120%;
            background: radial-gradient(circle at 20% 30%, rgba(255, 123, 172, 0.15) 0%, transparent 40%),
                        radial-gradient(circle at 80% 70%, rgba(112, 215, 255, 0.15) 0%, transparent 40%),
                        repeating-linear-gradient(45deg, rgba(185, 131, 255, 0.05) 0px, rgba(185, 131, 255, 0.05) 1px, transparent 1px, transparent 11px),
                        repeating-linear-gradient(135deg, rgba(185, 131, 255, 0.05) 0px, rgba(185, 131, 255, 0.05) 1px, transparent 1px, transparent 11px);
            z-index: -1;
            opacity: 0.5;
            transition: all 0.5s ease;
            background-image: url('https://patchwiki.biligame.com/images/sr/thumb/7/70/q495kbksg539afkr3azgzdb9l0uckj8.png/800px-%E6%BC%AB%E6%B8%B8%E6%B5%8B%E8%AF%954.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transform-origin: center;
        }
        
        .container {
            max-width: 1600px;
            width: 100%;
            padding: 20px;
            z-index: 1;
            min-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(30, 15, 50, 0.7);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 123, 172, 0.2) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
            z-index: -1;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #ff7bac, #70d7ff, #b983ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 20px rgba(185, 131, 255, 0.5);
            font-weight: 800;
            letter-spacing: 1px;
        }
        
        .subtitle {
            font-size: 1.15rem;
            color: #d0c4ff;
            max-width: 800px;
            margin: 10px auto 0;
            line-height: 1.7;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            flex: 1;
            overflow: hidden;
        }
        
        @media (max-width: 1400px) {
            .main-content {
                grid-template-columns: 1fr 2fr;
            }
            .visualization-section {
                display: none;
            }
        }
        
        @media (max-width: 1100px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        /* 播放列表样式 */
        .playlist-section {
            background: rgba(40, 20, 70, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            max-height: 180vh;
        }
        
        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .playlist-title {
            font-size: 1.6rem;
            color: #ff7bac;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .playlist-controls {
            display: flex;
            gap: 8px;
        }
        
        .playlist-btn {
            padding: 7px 12px;
            background: linear-gradient(135deg, #70d7ff, #b983ff);
            color: #1a0a2e;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .playlist-btn::after {
            content: attr(title);
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(40, 20, 70, 0.9);
            color: #e9e3ff;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        
        .playlist-btn:hover::after {
            opacity: 1;
        }
        
        .playlist-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(112, 215, 255, 0.4);
        }
        
        .playlist-items {
            flex: 1;
            overflow-y: auto;
            border-radius: 15px;
            background: rgba(30, 15, 50, 0.5);
            padding: 8px;
            max-height: calc(80vh - 120px);
            scrollbar-width: thin;
            scrollbar-color: #b983ff rgba(30, 15, 50, 0.5);
        }
        
        .playlist-items::-webkit-scrollbar {
            width: 8px;
        }
        
        .playlist-items::-webkit-scrollbar-track {
            background: rgba(30, 15, 50, 0.3);
            border-radius: 4px;
        }
        
        .playlist-items::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #ff7bac, #b983ff);
            border-radius: 4px;
        }
        
        .playlist-items::-webkit-scrollbar-thumb:hover {
            background: #70d7ff;
        }
        
        .playlist-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 6px;
            background: rgba(60, 30, 100, 0.4);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .playlist-item:hover {
            background: rgba(80, 40, 130, 0.6);
            transform: translateX(5px);
        }
        
        .playlist-item.active {
            background: linear-gradient(90deg, rgba(255, 123, 172, 0.6), rgba(185, 131, 255, 0.6));
            border-left: 4px solid #70d7ff;
        }
        
        .playlist-item-icon {
            font-size: 1.1rem;
            margin-right: 10px;
            color: #70d7ff;
        }
        
        .playlist-item-info {
            flex: 1;
        }
        
        .playlist-item-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #e9e3ff;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .playlist-item-artist {
            font-size: 0.85rem;
            color: #b983ff;
        }
        
        .playlist-item-duration {
            font-size: 0.85rem;
            color: #70d7ff;
            margin-left: 12px;
        }
        
        .playlist-item-remove {
            color: #ff7bac;
            font-size: 1rem;
            cursor: pointer;
            padding: 5px;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        
        .playlist-item-remove:hover {
            transform: scale(1.2);
            color: #ff4d94;
        }
        
        /* 播放器主区域 */
        .player-section {
            background: rgba(40, 20, 70, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        .player-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://patchwiki.biligame.com/images/sr/thumb/9/9b/q2hhex30udylhvilmxlm3jpr3fp9moa.png/400px-%E5%85%89%E9%94%A5-%E7%AB%8B%E7%BB%98-%E8%BF%99%E5%B0%B1%E6%98%AF%E6%88%91%E5%95%A6%EF%BC%81.png') center/cover no-repeat;
            opacity: 0.15;
            z-index: -1;
            transition: opacity 0.5s ease;
        }
        
        .vinyl-player {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 20px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .vinyl-disc {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: radial-gradient(circle, #0a0415 30%, #1a0a2e 70%);
            border: 15px solid #3a1e5a;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6),
                        inset 0 0 20px rgba(255, 255, 255, 0.1),
                        0 0 30px rgba(255, 123, 172, 0.3);
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.5s ease;
        }
        
        .vinyl-center {
            width: 60px;
            height: 60px;
            background: #ff7bac;
            border-radius: 50%;
            border: 8px solid #70d7ff;
            box-shadow: 0 0 20px rgba(112, 215, 255, 0.5);
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .vinyl-center::after {
            content: "";
            position: absolute;
            width: 15px;
            height: 15px;
            background: white;
            border-radius: 50%;
        }
        
        .vinyl-label {
            position: absolute;
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff7bac, #b983ff);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            z-index: 1;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .vinyl-label img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .vinyl-grooves {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: repeating-radial-gradient(
                circle,
                transparent,
                transparent 5px,
                rgba(255, 255, 255, 0.05) 5px,
                rgba(255, 255, 255, 0.05) 10px
            );
            z-index: 0;
        }
        
        .vinyl-arm {
            position: absolute;
            top: 35px;
            right: 45px;
            width: 160px;
            height: 160px;
            transform-origin: top right;
            z-index: 3;
        }
        
        .arm-base {
            position: absolute;
            top: 0;
            right: 0;
            width: 25px;
            height: 25px;
            background: #3a1e5a;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .arm-rod {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 135px;
            height: 6px;
            background: linear-gradient(to left, #3a1e5a, #5a2e8a);
            border-radius: 3px;
            transform: rotate(-30deg);
            transform-origin: top right;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .arm-head {
            position: absolute;
            top: 120px;
            right: 140px;
            width: 25px;
            height: 25px;
            background: #ff7bac;
            border-radius: 50%;
            border: 3px solid #70d7ff;
            box-shadow: 0 0 15px rgba(255, 123, 172, 0.5);
        }
        
        /* 当前播放歌曲名称 */
        .now-playing {
            text-align: center;
            font-size: 1.4rem;
            color: #ff7bac;
            margin: 15px 0 5px;
            font-weight: 600;
            text-shadow: 0 0 10px rgba(255, 123, 172, 0.7);
            min-height: 36px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 10px;
            line-height: 1.3;
        }
        
        .player-controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        
        .control-btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff7bac, #b983ff);
            color: white;
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(185, 131, 255, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .control-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
            border-radius: 50%;
        }
        
        .control-btn:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 12px 25px rgba(185, 131, 255, 0.6);
        }
        
        .control-btn:active {
            transform: translateY(2px);
        }
        
        .control-btn:disabled {
            background: linear-gradient(135deg, #5a4a75, #7a6a95);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .play-pause-btn {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #70d7ff, #b983ff);
        }
        
        .progress-container {
            margin-top: 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #b983ff;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(60, 30, 100, 0.4);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }
        
        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff7bac, #b983ff);
            border-radius: 10px;
            transition: width 0.1s linear;
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            width: 100%;
            position: relative;
        }
        
        .volume-control i {
            color: #70d7ff;
            font-size: 1.2rem;
            min-width: 24px;
        }
        
        .volume-slider-container {
            flex: 1;
            height: 6px;
            background: rgba(60, 30, 100, 0.4);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .volume-fill {
            position: absolute;
            height: 100%;
            width: 70%;
            background: linear-gradient(90deg, #70d7ff, #b983ff);
            border-radius: 10px;
            transition: width 0.1s linear;
        }
        
        .volume-slider {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .customization-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }
        
        .customization-group {
            background: rgba(30, 15, 50, 0.5);
            padding: 12px;
            border-radius: 15px;
            border: 2px solid rgba(112, 215, 255, 0.3);
        }
        
        .group-title {
            font-size: 1rem;
            color: #ff7bac;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bg-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .bg-btn {
            padding: 7px 12px;
            background: linear-gradient(135deg, #70d7ff, #b983ff);
            color: #1a0a2e;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .bg-btn::after {
            content: attr(title);
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(40, 20, 70, 0.9);
            color: #e9e3ff;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        
        .bg-btn:hover::after {
            opacity: 1;
        }
        
        .bg-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(112, 215, 255, 0.4);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        
        .slider-container input {
            flex: 1;
        }
        
        .visualization-section {
            background: rgba(40, 20, 70, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .visualizer-container {
            margin-bottom: 20px;
            background: rgba(30, 15, 50, 0.5);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            overflow: hidden;
            position: relative;
        }
        
        .visualizer-container:last-child {
            margin-bottom: 0;
        }
        
        .visualizer-title {
            font-size: 1.6rem;
            margin-bottom: 15px;
            color: #ff7bac;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(255, 123, 172, 0.3);
        }
        
        .visualizer-title i {
            color: #70d7ff;
            text-shadow: 0 0 10px rgba(112, 215, 255, 0.7);
        }
        
        .visualizer {
            width: 100%;
            height: 180px;
            background: rgba(20, 10, 40, 0.4);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* 角色容器 */
        .character-container {
            position: relative;
            height: 200px;
            margin-top: 20px;
            perspective: 1000px;
            display: flex;
            justify-content: center;
        }
        
        .character {
            position: absolute;
            bottom: 10px;
            width: 180px;
            height: 270px;
            background: url('https://ts1.tc.mm.bing.net/th/id/OIP-C.HWv3xdsRgiq6C5Rw3hE3YwHaHY?rs=1&pid=ImgDetMain') bottom/contain no-repeat;
            z-index: 0;
            opacity: 0.9;
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }
        
        .character::before {
            content: "";
            position: absolute;
            bottom: -10px;
            left: 50%;
            width: 55px;
            height: 8px;
            background: rgba(255, 123, 172, 0.4);
            border-radius: 50%;
            filter: blur(5px);
            transform: translateX(-50%);
            z-index: -1;
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            color: #a98fff;
            font-size: 0.9rem;
            width: 100%;
            border-top: 1px solid rgba(255, 123, 172, 0.2);
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }
        
        .footer-link {
            color: #70d7ff;
            text-decoration: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }
        
        .footer-link:hover {
            color: #ff7bac;
            text-shadow: 0 0 10px rgba(255, 123, 172, 0.5);
        }
        
        .circle-spectrum {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            perspective: 1000px;
        }
        
        .particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        /* Zen模式样式 */
        .zen-mode {
            overflow: hidden;
        }
        
        .zen-mode .container > *:not(.circle-spectrum):not(.particle-canvas):not(.bg-overlay):not(.character) {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }
        
        .zen-mode .circle-spectrum {
            z-index: 300; /* 提高z-index确保在Zen模式下显示 */
            display: block;
        }
        
        .zen-mode .circle-spectrum canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            z-index: 100;
        }
        
        .zen-mode .particle-canvas {
            z-index: 20;
        }
        
        .zen-mode #bgOverlay {
            z-index: 5;
        }
        
        /* 弹幕效果 */
        .danmaku {
            position: absolute;
            pointer-events: none;
            z-index: 400; /* 提高z-index确保在Zen模式下显示 */
            animation: danmakuMove 1.5s linear forwards;
            opacity: 0.8;
            filter: drop-shadow(0 0 5px rgba(255, 123, 172, 0.7));
            font-size: 28px;
            transform-origin: center;
        }
        
        @keyframes danmakuMove {
            0% { 
                transform: translate(0, 0) rotate(0deg) scale(0.5);
                opacity: 0.8;
            }
            100% { 
                transform: translate(var(--tx), var(--ty)) rotate(360deg) scale(1.5);
                opacity: 0;
            }
        }
        
        /* 按钮提示工具 */
        .tooltip {
            position: relative;
        }
        
        .tooltip::after {
            content: attr(title);
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(40, 20, 70, 0.9);
            color: #e9e3ff;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        
        .tooltip:hover::after {
            opacity: 1;
        }
        
        /* Zen模式按钮 */
        .zen-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, #ff7bac, #b983ff);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(185, 131, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .zen-toggle:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(185, 131, 255, 0.7);
        }
        
        /* 左右频谱柱状图 */
        .bar-canvas {
            position: fixed;
            top: 0;
            width: 50px;
            height: 100%;
            z-index: -1;
        }
        
        #leftBarCanvas {
            left: 0;
        }
        
        #rightBarCanvas {
            right: 0;
        }
        
        /* 放大图谱模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 5, 20, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .modal-content {
            position: relative;
            background: rgba(40, 20, 70, 0.9);
            border-radius: 20px;
            padding: 20px;
            width: 90%;
            height: 85%;
            max-width: 1200px;
            box-shadow: 0 0 50px rgba(185, 131, 255, 0.5);
            border: 1px solid rgba(255, 123, 172, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 123, 172, 0.3);
        }
        
        .modal-title {
            font-size: 1.8rem;
            color: #ff7bac;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: #70d7ff;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .close-modal:hover {
            color: #ff7bac;
            transform: scale(1.2);
        }
        
        .modal-canvas {
            width: 100%;
            height: calc(100% - 50px);
            background: rgba(20, 10, 40, 0.4);
            border-radius: 15px;
        }
        
        /* 性能优化提示 */
        .perf-warning {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 123, 172, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        /* 抢镜头像 - 只保留左下和右下 */
        .photo-bomb {
            position: fixed;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff7bac, #70d7ff, #b983ff);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(185, 131, 255, 0.7);
            transform: scale(0);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .photo-bomb img {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .photo-bomb.active {
            transform: scale(1);
            opacity: 1;
        }
        
        .photo-bomb.top-left {
            display: none; /* 删除左上角抢镜头像 */
        }
        
        .photo-bomb.bottom-left {
            bottom: 30px;
            left: 30px;
        }
        
        .photo-bomb.bottom-right {
            bottom: 30px;
            right: 30px;
        }
        
        /* 弹幕设置样式 */
        .danmaku-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .danmaku-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #5a4a75;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: #e9e3ff;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background: linear-gradient(135deg, #ff7bac, #b983ff);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* 霓虹灯光特效 */
        .neon-beam {
            position: fixed;
            height: 20px;
            background: linear-gradient(90deg, #ff7bac, #70d7ff, #b983ff);
            box-shadow: 0 0 10px #ff7bac, 0 0 20px #70d7ff, 0 0 30px #b983ff;
            z-index: 0;
            opacity: 0.8;
            transform-origin: left center;
            pointer-events: none;
            animation: beamFade 0.6s forwards;
        }
        
        @keyframes beamFade {
            0% {
                width: 0;
                opacity: 0.9;
            }
            70% {
                opacity: 0.8;
            }
            100% {
                width: var(--beam-length);
                opacity: 0;
            }
        }
        
        /* 音符弹幕 */
        .note-danmaku {
            position: absolute;
            pointer-events: none;
            z-index: 150;
            font-size: 36px;
            animation: noteMove 1.5s ease-out forwards;
            filter: drop-shadow(0 0 8px currentColor);
        }
        
        @keyframes noteMove {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(0.8);
            }
            100% {
                opacity: 0;
                transform: translate(var(--tx), var(--ty)) scale(1.2);
            }
        }
        
        /* 星光特效 */
        .starlight {
            position: absolute;
            pointer-events: none;
            z-index: 100;
            font-size: 0;
            animation: starlightPulse 1s ease-out forwards;
        }
        
        @keyframes starlightPulse {
            0% {
                transform: scale(0.5);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        /* 莫比乌斯环 */
        .mobius-ring {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 150;
            pointer-events: none;
        }
        
        .mobius-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff7bac, #70d7ff);
            box-shadow: 0 0 15px rgba(185, 131, 255, 0.8);
            transform-origin: center center;
            animation: mobiusRotate 5s infinite linear;
        }
        
        @keyframes mobiusRotate {
            0% {
                transform: rotate(0deg) translateX(150px) rotate(0deg);
            }
            100% {
                transform: rotate(360deg) translateX(150px) rotate(-360deg);
            }
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        
        .toggle-label {
            font-size: 0.9rem;
            color: #d0c4ff;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .vinyl-player {
                max-width: 100%;
            }
            
            .vinyl-disc {
                width: 240px;
                height: 240px;
            }
            
            .character {
                display: none;
            }
            
            .customization-panel {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .bar-canvas {
                display: none;
            }
            
            .photo-bomb {
                width: 80px;
                height: 80px;
            }
            
            .photo-bomb img {
                width: 75px;
                height: 75px;
            }
        }
        
        /* 音频波纹动画 */
        @keyframes audio-wave {
            0% { transform: scaleY(0.2); }
            50% { transform: scaleY(1); }
            100% { transform: scaleY(0.2); }
        }
        
        @keyframes dance {
            0% { transform: translateY(0) rotate(0deg) translateZ(50px); }
            25% { transform: translateY(-20px) rotate(-2deg) translateZ(60px); }
            50% { transform: translateY(0) rotate(0deg) translateZ(50px); }
            75% { transform: translateY(-15px) rotate(2deg) translateZ(60px); }
            100% { transform: translateY(0) rotate(0deg) translateZ(50px); }
        }
        
        @keyframes spiral {
            0% {
                transform: rotate(0deg) translate(0, 0) scale(0.5);
            }
            100% {
                transform: rotate(1080deg) translate(var(--distance), 0) scale(1.5);
            }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes photoBomb {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="bgOverlay"></div>
    <canvas id="leftBarCanvas" class="bar-canvas"></canvas>
    <canvas id="rightBarCanvas" class="bar-canvas"></canvas>
    <div class="circle-spectrum" id="circleSpectrum"></div>
    <canvas id="particleCanvas" class="particle-canvas"></canvas>
    
    <!-- 抢镜头像 - 只保留左下和右下 -->
    <div class="photo-bomb bottom-left" id="photoBomb1">
        <img src="https://tse3-mm.cn.bing.net/th/id/OIP-C.nixqEv-bXXxU-6BOgSS8mQHaHa?w=206&h=206&c=7&r=0&o=5&pid=1.7" alt="抢镜头像">
    </div>
    <div class="photo-bomb bottom-right" id="photoBomb2">
        <img src="https://tse4-mm.cn.bing.net/th/id/OIP-C.sjIon1EGLny8Yjr1pAf--QHaHa?w=199&h=199&c=7&r=0&o=5&pid=1.7" alt="抢镜头像">
    </div>
    
    <!-- 性能提示 -->
    <div class="perf-warning" id="perfWarning">
        <i class="fas fa-exclamation-triangle"></i> 性能模式已启用
    </div>
    
    <!-- 放大图谱模态框 -->
    <div class="modal" id="waveformModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-wave-square"></i> 音频波形 - 放大视图</h2>
                <button class="close-modal" id="closeWaveformModal">&times;</button>
            </div>
            <canvas class="modal-canvas" id="waveformModalCanvas"></canvas>
        </div>
    </div>
    
    <div class="modal" id="waterfallModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-water"></i> 瀑布频谱 - 放大视图</h2>
                <button class="close-modal" id="closeWaterfallModal">&times;</button>
            </div>
            <canvas class="modal-canvas" id="waterfallModalCanvas"></canvas>
        </div>
    </div>
    
    <button class="zen-toggle tooltip" id="zenToggle" title="切换沉浸式音乐体验">
        <i class="fas fa-expand"></i> Zen模式
    </button>
    
    <div class="container">
        <header>
            <h1><i class="fas fa-music"></i> 「崩坏：星穹铁道」主题 - 音乐可视化播放器</h1>
            <p class="subtitle">探索宇宙的旋律，感受星穹的节奏。上传您的音频，体验三月七配色的梦幻可视化效果</p>
        </header>
        
        <div class="main-content">
            <!-- 左侧播放列表 -->
            <div class="playlist-section">
                <div class="playlist-header">
                    <h2 class="playlist-title"><i class="fas fa-list"></i> 播放列表</h2>
                    <div class="playlist-controls">
                        <button class="playlist-btn tooltip" id="audioUploadBtn" title="上传音频文件">
                            <i class="fas fa-upload"></i>
                        </button>
                        <button class="playlist-btn tooltip" id="clearPlaylist" title="清空播放列表">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="playlist-btn tooltip" id="shufflePlaylist" title="随机播放">
                            <i class="fas fa-random"></i>
                        </button>
                    </div>
                </div>
                <div class="playlist-items" id="playlist">
                    <!-- 播放列表将由JS动态生成 -->
                </div>
            </div>
            
            <!-- 中间播放器 -->
            <div class="player-section">
                <div class="vinyl-player">
                    <div class="vinyl-disc" id="vinylDisc">
                        <div class="vinyl-grooves"></div>
                        <div class="vinyl-label">
                            <img id="albumArt" src="https://patchwiki.biligame.com/images/sr/thumb/2/2e/d92nzv261q5e18sec93pfzie8kdjaok.png/330px-%E5%BC%80%E6%9C%8D%E5%80%92%E8%AE%A1%E6%97%B6-%E4%B8%89%E6%9C%88%E4%B8%83.png" alt="星穹铁道">
                        </div>
                        <div class="vinyl-center"></div>
                    </div>
                    <div class="vinyl-arm">
                        <div class="arm-base"></div>
                        <div class="arm-rod"></div>
                        <div class="arm-head"></div>
                    </div>
                </div>
                
                <div id="nowPlaying" class="now-playing">未选择歌曲</div>
                
                <div class="player-controls">
                    <button id="prevBtn" class="control-btn tooltip" title="上一首">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button id="playPauseBtn" class="control-btn play-pause-btn tooltip" disabled title="播放/暂停">
                        <i class="fas fa-play"></i>
                    </button>
                    <button id="nextBtn" class="control-btn tooltip" title="下一首">
                        <i class="fas fa-step-forward"></i>
                    </button>
                </div>
                
                <div class="progress-container">
                    <div class="progress-label">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    
                    <div class="volume-control">
                        <i class="fas fa-volume-up"></i>
                        <div class="volume-slider-container">
                            <div class="volume-fill" id="volumeFill"></div>
                            <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.01" value="0.7">
                        </div>
                    </div>
                </div>
                
                <div class="customization-panel">
                    <div class="customization-group">
                        <div class="group-title">
                            <i class="fas fa-image"></i> 背景设置
                        </div>
                        <div class="bg-controls">
                            <button class="bg-btn tooltip" id="bgUploadBtn" title="上传自定义背景">
                                <i class="fas fa-upload"></i> 上传背景
                            </button>
                            <button class="bg-btn tooltip" id="clearBgBtn" title="重置背景">
                                <i class="fas fa-trash"></i> 重置
                            </button>
                        </div>
                        <div class="slider-container">
                            <i class="fas fa-sun" style="color: #ff7bac;"></i>
                            <input type="range" id="bgOpacity" min="0" max="100" value="50">
                            <i class="fas fa-sun" style="color: #70d7ff;"></i>
                        </div>
                    </div>
                    
                    <div class="customization-group">
                        <div class="group-title">
                            <i class="fas fa-user"></i> 角色设置
                        </div>
                        <div class="bg-controls">
                            <button class="bg-btn tooltip" id="charUploadBtn" title="上传自定义角色">
                                <i class="fas fa-upload"></i> 上传角色
                            </button>
                            <button class="bg-btn tooltip" id="clearCharBtn" title="重置角色">
                                <i class="fas fa-trash"></i> 重置
                            </button>
                        </div>
                        <div class="slider-container">
                            <i class="fas fa-moon" style="color: #ff7bac;"></i>
                            <input type="range" id="charOpacity" min="0" max="100" value="90">
                            <i class="fas fa-sun" style="color: #70d7ff;"></i>
                        </div>
                    </div>
                    
                    <div class="customization-group">
                        <div class="group-title">
                            <i class="fas fa-camera"></i> 抢镜头像
                        </div>
                        <div class="bg-controls">
                            <button class="bg-btn tooltip" id="bombUploadBtn" title="上传自定义抢镜头像">
                                <i class="fas fa-upload"></i> 上传头像
                            </button>
                            <button class="bg-btn tooltip" id="clearBombBtn" title="重置头像">
                                <i class="fas fa-trash"></i> 重置
                            </button>
                        </div>
                    </div>
                    
                    <!-- 新增弹幕设置 -->
                    <div class="customization-group">
                        <div class="group-title">
                            <i class="fas fa-comment-alt"></i> Zen弹幕设置
                        </div>
                        <div class="danmaku-controls">
                            <div class="danmaku-toggle">
                                <label class="switch">
                                    <input type="checkbox" id="danmakuToggle" checked>
                                    <span class="slider"></span>
                                </label>
                                <span>开启弹幕</span>
                            </div>
                            
                            <div class="slider-container">
                                <i class="fas fa-tachometer-alt" style="color: #ff7bac;"></i>
                                <input type="range" id="danmakuSpeed" min="0.5" max="2" step="0.1" value="1">
                                <i class="fas fa-tachometer-alt" style="color: #70d7ff;"></i>
                                <span>速度</span>
                            </div>
                            
                            <div class="slider-container">
                                <i class="fas fa-bolt" style="color: #ff7bac;"></i>
                                <input type="range" id="danmakuFrequency" min="0.1" max="1" step="0.1" value="0.5">
                                <i class="fas fa-bolt" style="color: #70d7ff;"></i>
                                <span>频率</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧频谱可视化 -->
            <div class="visualization-section">
                <div class="visualizer-container">
                    <div class="visualizer-title">
                        <i class="fas fa-wave-square"></i> 音频波形
                        <div class="toggle-container">
                            <span class="toggle-label">开启</span>
                            <label class="switch">
                                <input type="checkbox" id="waveformToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="visualizer">
                        <canvas id="waveform" class="zoomable"></canvas>
                    </div>
                </div>
                
                <div class="visualizer-container">
                    <div class="visualizer-title">
                        <i class="fas fa-water"></i> 瀑布频谱
                        <div class="toggle-container">
                            <span class="toggle-label">开启</span>
                            <label class="switch">
                                <input type="checkbox" id="waterfallToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="visualizer">
                        <canvas id="waterfall" class="zoomable"></canvas>
                    </div>
                </div>
                
                <!-- 角色容器 -->
                <div class="character-container">
                    <div class="character" id="character"></div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2025 崩坏：星穹铁道风格音频可视化 | 三月七主题| 使用Web Audio API技术| 核心代码全部通过与DS对话生成</p>
            <div class="footer-links">
                
                <a href="https://space.bilibili.com/20413499?spm_id_from=333.1007.0.0" class="footer-link"><i class="fas fa-book"></i> Akari_404</a>
                <a href="https://www.deepseek.com/" class="footer-link"><i class="fas fa-star"></i> deepseek</a>
                
            </div>
        </footer>
    </div>
    
    <!-- 隐藏的文件输入 -->
    <input type="file" id="audioFile" accept="audio/*" style="display: none;" multiple>
    <input type="file" id="bgFile" accept="image/*" style="display: none;">
    <input type="file" id="charFile" accept="image/*" style="display: none;">
    <input type="file" id="coverFile" accept="image/*" style="display: none;">
    <input type="file" id="bombFile" accept="image/*" style="display: none;">

    <script>
        // ===================== 性能优化配置 =====================
        const OPTIMIZATION = {
            VISUALIZATION_FPS: 30,
            MAX_PARTICLES: 150,
            MAX_DANMAKU: 50,
            WATERFALL_RESOLUTION: 1,
            LOW_PERF_THRESHOLD: 4,
            LOW_PERF_MODE: false,
            LAST_VISUALIZATION_TIME: 0
        };
        
        // ===================== 弹幕设置 =====================
        const DANMAKU_SETTINGS = {
            enabled: true,
            speed: 1.0,
            frequency: 0.5
        };
        
        // ===================== 状态管理 =====================
        const STATE = {
            isPlaying: false,
            isZenMode: false,
            audioContext: null,
            audioElement: null,
            source: null,
            analyser: null,
            playlistItems: [],
            currentTrackIndex: 0,
            customCover: null,
            customCharUrl: null,
            customBombUrl: null,
            visualizationId: null,
            updateProgressId: null,
            circleSpectrumAnimationId: null,
            lastDanmakuTime: 0,
            spiralAngle: 0,
            lastBeatTime: 0,
            lastBombTime: 0,
            beatInterval: 500,
            beatSensitivity: 0.5,
            lowFrequencyData: null,
            defaultBg: 'https://patchwiki.biligame.com/images/sr/thumb/7/70/q495kbksg539afkr3azgzdb9l0uckj8.png/800px-%E6%BC%AB%E6%B8%B8%E6%B5%8B%E8%AF%954.png',
            defaultChar: 'https://ts1.tc.mm.bing.net/th/id/OIP-C.HWv3xdsRgiq6C5Rw3hE3YwHaHY?rs=1&pid=ImgDetMain',
            zenEffectsActive: false,
            mobiusRing: null,
            lastNoteDanmakuTime: 0,
            waveformEnabled: false, // 默认关闭波形
            waterfallEnabled: false // 默认关闭频谱
        };
        
        // ===================== DOM 引用 =====================
        const DOM = {
            audioFileInput: document.getElementById('audioFile'),
            bgFileInput: document.getElementById('bgFile'),
            charFileInput: document.getElementById('charFile'),
            coverFileInput: document.getElementById('coverFile'),
            bombFileInput: document.getElementById('bombFile'),
            playPauseBtn: document.getElementById('playPauseBtn'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            clearPlaylistBtn: document.getElementById('clearPlaylist'),
            shufflePlaylistBtn: document.getElementById('shufflePlaylist'),
            audioUploadBtn: document.getElementById('audioUploadBtn'),
            bgUploadBtn: document.getElementById('bgUploadBtn'),
            clearBgBtn: document.getElementById('clearBgBtn'),
            charUploadBtn: document.getElementById('charUploadBtn'),
            clearCharBtn: document.getElementById('clearCharBtn'),
            bombUploadBtn: document.getElementById('bombUploadBtn'),
            clearBombBtn: document.getElementById('clearBombBtn'),
            bgOpacitySlider: document.getElementById('bgOpacity'),
            charOpacitySlider: document.getElementById('charOpacity'),
            volumeSlider: document.getElementById('volumeSlider'),
            volumeFill: document.getElementById('volumeFill'),
            bgOverlay: document.getElementById('bgOverlay'),
            waveformCanvas: document.getElementById('waveform'),
            waterfallCanvas: document.getElementById('waterfall'),
            vinylDisc: document.getElementById('vinylDisc'),
            albumArt: document.getElementById('albumArt'),
            circleSpectrum: document.getElementById('circleSpectrum'),
            particlesCanvas: document.getElementById('particleCanvas'),
            particlesCtx: null,
            character: document.getElementById('character'),
            playlist: document.getElementById('playlist'),
            zenToggle: document.getElementById('zenToggle'),
            progressBar: document.getElementById('progressBar'),
            progressFill: document.getElementById('progressFill'),
            currentTimeEl: document.getElementById('currentTime'),
            totalTimeEl: document.getElementById('totalTime'),
            nowPlayingEl: document.getElementById('nowPlaying'),
            leftBarCanvas: document.getElementById('leftBarCanvas'),
            rightBarCanvas: document.getElementById('rightBarCanvas'),
            perfWarning: document.getElementById('perfWarning'),
            waveformModal: document.getElementById('waveformModal'),
            waterfallModal: document.getElementById('waterfallModal'),
            closeWaveformModal: document.getElementById('closeWaveformModal'),
            closeWaterfallModal: document.getElementById('closeWaterfallModal'),
            waveformModalCanvas: document.getElementById('waveformModalCanvas'),
            waterfallModalCanvas: document.getElementById('waterfallModalCanvas'),
            photoBomb1: document.getElementById('photoBomb1'),
            photoBomb2: document.getElementById('photoBomb2'),
            danmakuToggle: document.getElementById('danmakuToggle'),
            danmakuSpeed: document.getElementById('danmakuSpeed'),
            danmakuFrequency: document.getElementById('danmakuFrequency'),
            mobiusRing: document.createElement('div'),
            waveformToggle: document.getElementById('waveformToggle'),
            waterfallToggle: document.getElementById('waterfallToggle')
        };
        
        // Canvas 上下文
        const CTX = {
            waveform: DOM.waveformCanvas.getContext('2d'),
            waterfall: DOM.waterfallCanvas.getContext('2d'),
            leftBar: DOM.leftBarCanvas.getContext('2d'),
            rightBar: DOM.rightBarCanvas.getContext('2d'),
            waveformModal: DOM.waveformModalCanvas.getContext('2d'),
            waterfallModal: DOM.waterfallModalCanvas.getContext('2d'),
            particles: null
        };
        
        // 瀑布图数据
        let waterfallData = [];
        let waterfallModalData = [];
        const waterfallHeight = 256;
        
        // 粒子系统
        let particles = [];
        let particlePool = [];
        
        // ===================== 初始化函数 =====================
        function init() {
            // 初始化Canvas
            resizeCanvas();
            DOM.particlesCtx = DOM.particlesCanvas.getContext('2d');
            CTX.particles = DOM.particlesCtx;
            
            // 检查设备性能
            checkDevicePerformance();
            
            // 初始化音频系统
            initAudioSystem();
            
            // 绑定事件
            bindEvents();
            
            // 初始禁用控制按钮
            DOM.playPauseBtn.disabled = true;
            
            // 初始粒子效果
            createInitialParticles();
            
            // 创建莫比乌斯环容器
            DOM.mobiusRing.className = 'mobius-ring';
            DOM.mobiusRing.style.display = 'none';
            document.body.appendChild(DOM.mobiusRing);
            
            // 设置默认状态
            DOM.waveformToggle.checked = STATE.waveformEnabled;
            DOM.waterfallToggle.checked = STATE.waterfallEnabled;
        }
        
        // 检查设备性能并调整设置
        function checkDevicePerformance() {
            const cores = navigator.hardwareConcurrency || 4;
            const memory = navigator.deviceMemory || 4;
            
            if (cores < OPTIMIZATION.LOW_PERF_THRESHOLD || memory < 4) {
                OPTIMIZATION.LOW_PERF_MODE = true;
                OPTIMIZATION.VISUALIZATION_FPS = 20;
                OPTIMIZATION.MAX_PARTICLES = 80;
                OPTIMIZATION.MAX_DANMAKU = 30;
                OPTIMIZATION.WATERFALL_RESOLUTION = 0.5;
                DOM.perfWarning.style.display = 'block';
            }
        }
        
        // 初始化音频系统
        function initAudioSystem() {
            if (!STATE.audioContext) {
                STATE.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            if (!STATE.analyser) {
                STATE.analyser = STATE.audioContext.createAnalyser();
                STATE.analyser.fftSize = 2048;
                STATE.analyser.smoothingTimeConstant = 0.8;
                STATE.lowFrequencyData = new Uint8Array(STATE.analyser.frequencyBinCount);
            }
        }
        
        // 绑定所有事件
        function bindEvents() {
            // 文件上传
            DOM.audioUploadBtn.addEventListener('click', () => DOM.audioFileInput.click());
            DOM.audioFileInput.addEventListener('change', handleAudioUpload);
            
            DOM.bgUploadBtn.addEventListener('click', () => DOM.bgFileInput.click());
            DOM.bgFileInput.addEventListener('change', handleBgUpload);
            
            DOM.charUploadBtn.addEventListener('click', () => DOM.charFileInput.click());
            DOM.charFileInput.addEventListener('change', handleCharUpload);
            
            DOM.bombUploadBtn.addEventListener('click', () => DOM.bombFileInput.click());
            DOM.bombFileInput.addEventListener('change', handleBombUpload);
            
            DOM.albumArt.addEventListener('click', () => DOM.coverFileInput.click());
            DOM.coverFileInput.addEventListener('change', handleCoverUpload);
            
            // 控制按钮
            DOM.playPauseBtn.addEventListener('click', togglePlayPause);
            DOM.prevBtn.addEventListener('click', playPrev);
            DOM.nextBtn.addEventListener('click', playNext);
            
            // 播放列表控制
            DOM.clearPlaylistBtn.addEventListener('click', clearPlaylist);
            DOM.shufflePlaylistBtn.addEventListener('click', shufflePlaylist);
            
            // 其他控件
            DOM.bgOpacitySlider.addEventListener('input', updateBgOpacity);
            DOM.charOpacitySlider.addEventListener('input', updateCharOpacity);
            DOM.volumeSlider.addEventListener('input', updateVolume);
            DOM.progressBar.addEventListener('click', updateProgressPosition);
            
            // Zen模式
            DOM.zenToggle.addEventListener('click', toggleZenMode);
            
            // 模态框
            DOM.closeWaveformModal.addEventListener('click', () => closeModal(DOM.waveformModal));
            DOM.closeWaterfallModal.addEventListener('click', () => closeModal(DOM.waterfallModal));
            DOM.waveformCanvas.addEventListener('dblclick', () => openModal(DOM.waveformModal));
            DOM.waterfallCanvas.addEventListener('dblclick', () => openModal(DOM.waterfallModal));
            
            // 窗口大小调整
            window.addEventListener('resize', resizeCanvas);
            
            // 背景视差效果 - 提高响应速度
            document.addEventListener('mousemove', handleMouseMove);
            
            // 页面卸载
            window.addEventListener('beforeunload', cleanup);
            
            // 抢镜头像控制
            DOM.clearBombBtn.addEventListener('click', resetBombImage);
            
            // 弹幕设置控制
            DOM.danmakuToggle.addEventListener('change', function() {
                DANMAKU_SETTINGS.enabled = this.checked;
            });
            DOM.danmakuSpeed.addEventListener('input', function() {
                DANMAKU_SETTINGS.speed = parseFloat(this.value);
            });
            DOM.danmakuFrequency.addEventListener('input', function() {
                DANMAKU_SETTINGS.frequency = parseFloat(this.value);
            });
            
            // 重置背景和角色设置
            DOM.clearBgBtn.addEventListener('click', clearBackground);
            DOM.clearCharBtn.addEventListener('click', clearCharacter);
            
            // 可视化开关控制
            DOM.waveformToggle.addEventListener('change', function() {
                STATE.waveformEnabled = this.checked;
                if (!STATE.waveformEnabled) {
                    CTX.waveform.clearRect(0, 0, DOM.waveformCanvas.width, DOM.waveformCanvas.height);
                }
            });
            
            DOM.waterfallToggle.addEventListener('change', function() {
                STATE.waterfallEnabled = this.checked;
                if (!STATE.waterfallEnabled) {
                    CTX.waterfall.clearRect(0, 0, DOM.waterfallCanvas.width, DOM.waterfallCanvas.height);
                }
            });
        }
        
        // 处理鼠标移动（背景视差效果）- 提高响应速度
        function handleMouseMove(e) {
            const mouseX = e.clientX / window.innerWidth;
            const mouseY = e.clientY / window.innerHeight;
            
            // 提高响应速度 - 增加系数到10
            const moveX = (1.5 + mouseX) * 10; // 反向移动
            const moveY = (0.5 - mouseY) * 10; // 反向移动
            
            DOM.bgOverlay.style.backgroundPosition = `${50 + moveX}% ${50 + moveY}%`;
        }
        
        // ===================== 核心功能 =====================
        // 处理音频上传
        function handleAudioUpload(e) {
            if (e.target.files.length > 0) {
                for (let i = 0; i < e.target.files.length; i++) {
                    loadAudioFile(e.target.files[i]);
                }
            }
        }
        
        // 加载音频文件
        function loadAudioFile(file) {
            if (!file) return;
            const fileURL = URL.createObjectURL(file);
            addToPlaylist(file.name, fileURL);
        }
        
        // 添加到播放列表
        function addToPlaylist(title, url) {
            const newItem = {
                title: title,
                url: url,
                duration:  "",
            };
            
            STATE.playlistItems.push(newItem);
            renderPlaylist();
            
            if (STATE.playlistItems.length === 1) {
                selectTrack(0);
            }
        }
        
        // 渲染播放列表
        function renderPlaylist() {
            DOM.playlist.innerHTML = '';
            
            STATE.playlistItems.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = `playlist-item ${index === STATE.currentTrackIndex ? 'active' : ''}`;
                itemEl.innerHTML = `
                    <div class="playlist-item-icon"><i class="fas fa-music"></i></div>
                    <div class="playlist-item-info">
                        <div class="playlist-item-title">${item.title}</div>
                        <div class="playlist-item-artist">${item.title}</div>
                    </div>
                    <div class="playlist-item-duration">${item.duration}</div>
                    <div class="playlist-item-remove" title="移除歌曲">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                
                itemEl.addEventListener('dblclick', () => {
                    selectTrack(index);
                    playAudio();
                });
                
                // 添加移除按钮事件
                const removeBtn = itemEl.querySelector('.playlist-item-remove');
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeTrack(index);
                });
                
                DOM.playlist.appendChild(itemEl);
            });
        }
        
        // 移除指定音轨
        function removeTrack(index) {
            // 如果移除的是当前播放的歌曲
            if (index === STATE.currentTrackIndex) {
                if (STATE.isPlaying) {
                    pauseAudio();
                    stopVisualizations();
                }
                
                // 如果列表还有歌曲，尝试播放下一首
                if (STATE.playlistItems.length > 1) {
                    STATE.currentTrackIndex = index >= STATE.playlistItems.length - 1 ? 0 : index;
                    selectTrack(STATE.currentTrackIndex);
                    setTimeout(playAudio, 500);
                } else {
                    // 列表为空
                    STATE.audioElement = null;
                    DOM.nowPlayingEl.textContent = "未选择歌曲";
                    DOM.playPauseBtn.disabled = true;
                    stopVisualizations();
                    resetVisualizations();
                    clearCanvas();
                }
            } else if (index < STATE.currentTrackIndex) {
                // 如果移除的是当前播放之前的歌曲，更新当前索引
                STATE.currentTrackIndex--;
            }
            
            // 从播放列表中移除
            STATE.playlistItems.splice(index, 1);
            renderPlaylist();
        }
        
        // 选择音轨
        function selectTrack(index) {
            STATE.currentTrackIndex = index;
            renderPlaylist();
            loadAudioFromURL(STATE.playlistItems[index].url, STATE.playlistItems[index].title);
        }
        
        // 从URL加载音频
        function loadAudioFromURL(url, name = "音频") {
            // 释放之前的资源
            releaseAudioResources();
            
            DOM.nowPlayingEl.textContent = name;
            
            STATE.audioElement = new Audio(url);
            STATE.audioElement.crossOrigin = "anonymous";
            STATE.audioElement.preload = "auto";
            STATE.audioElement.volume = DOM.volumeSlider.value;
            updateVolumeFill();
            
            STATE.audioElement.onloadedmetadata = () => {
                DOM.playPauseBtn.disabled = false;
                DOM.totalTimeEl.textContent = formatTime(STATE.audioElement.duration);
                
                // 旋转黑胶唱片
                DOM.vinylDisc.style.animation = "none";
                setTimeout(() => {
                    DOM.vinylDisc.style.animation = "rotate 5s linear infinite";
                }, 10);
                
                // 更新进度条
                STATE.updateProgressId = setInterval(updateProgress, 500);
            };
            
            STATE.audioElement.onerror = () => {
                DOM.playPauseBtn.disabled = true;
            };
            
            STATE.audioElement.onended = () => {
                STATE.isPlaying = false;
                DOM.playPauseBtn.querySelector('i').className = 'fas fa-play';
                DOM.vinylDisc.style.animation = "none";
                stopVisualizations();
                resetVisualizations();
                playNext();
            };
            
            setupAudioGraph();
        }
        
        // 设置音频处理图
        function setupAudioGraph() {
            initAudioSystem();
            
            if (STATE.source) {
                STATE.source.disconnect();
            }
            
            STATE.source = STATE.audioContext.createMediaElementSource(STATE.audioElement);
            STATE.source.connect(STATE.analyser);
            STATE.analyser.connect(STATE.audioContext.destination);
        }
        
        // 播放音频
        function playAudio() {
            if (!STATE.audioElement) return;
            
            if (STATE.audioContext.state === 'suspended') {
                STATE.audioContext.resume();
            }
            
            STATE.audioElement.play().then(() => {
                STATE.isPlaying = true;
                DOM.playPauseBtn.disabled = false;
                DOM.playPauseBtn.querySelector('i').className = 'fas fa-pause';
                DOM.vinylDisc.style.animation = "rotate 5s linear infinite";
                visualize();
            }).catch(error => {
                console.error("播放错误:", error);
            });
        }
        
        // 暂停音频
        function pauseAudio() {
            if (!STATE.audioElement) return;
            
            STATE.audioElement.pause();
            STATE.isPlaying = false;
            DOM.playPauseBtn.disabled = false;
            DOM.playPauseBtn.querySelector('i').className = 'fas fa-play';
            DOM.vinylDisc.style.animationPlayState = 'paused';
            DOM.character.style.animation = 'none';
            stopVisualizations();
        }
        
        // 切换播放/暂停
        function togglePlayPause() {
            if (STATE.isPlaying) {
                pauseAudio();
            } else {
                playAudio();
            }
        }
        
        // 播放下一首
        function playNext() {
            STATE.currentTrackIndex = (STATE.currentTrackIndex + 1) % STATE.playlistItems.length;
            selectTrack(STATE.currentTrackIndex);
            setTimeout(playAudio, 500);
        }
        
        // 播放上一首
        function playPrev() {
            STATE.currentTrackIndex = (STATE.currentTrackIndex - 1 + STATE.playlistItems.length) % STATE.playlistItems.length;
            selectTrack(STATE.currentTrackIndex);
            setTimeout(playAudio, 500);
        }
        
        // 清除播放列表
        function clearPlaylist() {
            STATE.playlistItems = [];
            STATE.currentTrackIndex = 0;
            renderPlaylist();
            if (STATE.audioElement) {
                pauseAudio();
                stopVisualizations();
                resetVisualizations();
                clearCanvas();
                DOM.nowPlayingEl.textContent = "未选择歌曲";
            }
        }
        
        // 随机播放
        function shufflePlaylist() {
            for (let i = STATE.playlistItems.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [STATE.playlistItems[i], STATE.playlistItems[j]] = [STATE.playlistItems[j], STATE.playlistItems[i]];
            }
            
            if (STATE.isPlaying) {
                const currentItem = STATE.playlistItems.splice(STATE.currentTrackIndex, 1)[0];
                STATE.playlistItems.unshift(currentItem);
                STATE.currentTrackIndex = 0;
            }
            
            renderPlaylist();
        }
        
        // ===================== 可视化功能 =====================
        // 可视化入口
        function visualize() {
            if (!STATE.isPlaying) return;
            
            // 设置缓冲区
            const bufferLength = STATE.analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const freqData = new Uint8Array(bufferLength);
            
            // 可视化循环
            function visualizeLoop() {
                if (!STATE.isPlaying) return;
                
                // 节流控制
                const now = Date.now();
                const delta = now - OPTIMIZATION.LAST_VISUALIZATION_TIME;
                if (delta < 1000 / OPTIMIZATION.VISUALIZATION_FPS) {
                    STATE.visualizationId = requestAnimationFrame(visualizeLoop);
                    return;
                }
                OPTIMIZATION.LAST_VISUALIZATION_TIME = now;
                
                // 获取分析数据
                STATE.analyser.getByteTimeDomainData(dataArray);
                STATE.analyser.getByteFrequencyData(freqData);
                
                // 绘制主视图
                if (STATE.waveformEnabled) {
                    drawWaveform(CTX.waveform, DOM.waveformCanvas, dataArray);
                }
                if (STATE.waterfallEnabled) {
                    drawWaterfall(CTX.waterfall, DOM.waterfallCanvas, waterfallData, freqData);
                }
                
                // 绘制放大视图（如果打开）
                if (DOM.waveformModal.style.display === 'flex') {
                    drawWaveform(CTX.waveformModal, DOM.waveformModalCanvas, dataArray);
                }
                if (DOM.waterfallModal.style.display === 'flex') {
                    drawWaterfall(CTX.waterfallModal, DOM.waterfallModalCanvas, waterfallModalData, freqData);
                }
                
                // 绘制左右柱状图
                drawBars(freqData);
                
                // 绘制粒子
                drawParticles();
                
                // 检测节拍并触发抢镜头像
                const volume = detectBeat(freqData);
                if (volume > 0.4) {
                    triggerPhotoBomb();
                    
                    // 在人物周围创建音符弹幕
                    createNoteDanmaku();
                }
                
                // 递归调用以持续更新
                STATE.visualizationId = requestAnimationFrame(visualizeLoop);
            }
            
            // 启动可视化
            visualizeLoop();
            
            // 绘制圆环频谱
            STATE.analyser.getByteFrequencyData(freqData);
            drawCircleSpectrum(freqData);
        }
        
        // 触发抢镜头像
        function triggerPhotoBomb() {
            const now = Date.now();
            if (now - STATE.lastBombTime < 500) return; // 0.5秒冷却
            
            STATE.lastBombTime = now;
            
            // 随机选择一个位置 (只保留左下和右下)
            const positions = ['bottom-left', 'bottom-right'];
            const position = positions[Math.floor(Math.random() * positions.length)];
            
            // 隐藏所有抢镜头像
            DOM.photoBomb1.classList.remove('active');
            DOM.photoBomb2.classList.remove('active');
            
            // 显示选中的抢镜头像
            let bombElement;
            switch(position) {
                case 'bottom-left':
                    bombElement = DOM.photoBomb1;
                    break;
                case 'bottom-right':
                    bombElement = DOM.photoBomb2;
                    break;
            }
            
            bombElement.classList.add('active');
            
            // 创建霓虹灯光特效
            createNeonBeam(bombElement);
            
            // 1.5秒后隐藏
            setTimeout(() => {
                bombElement.classList.remove('active');
            }, 1500);
        }
        
        // 创建霓虹灯光特效
        function createNeonBeam(sourceElement) {
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            
            const rect = sourceElement.getBoundingClientRect();
            const sourceX = rect.left + rect.width / 2;
            const sourceY = rect.top + rect.height / 2;
            
            // 计算到屏幕中心的距离和角度
            const dx = centerX - sourceX;
            const dy = centerY - sourceY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            // 创建光束元素
            const beam = document.createElement('div');
            beam.className = 'neon-beam';
            beam.style.left = `${sourceX}px`;
            beam.style.top = `${sourceY}px`;
            beam.style.transform = `rotate(${angle}deg)`;
            beam.style.setProperty('--beam-length', `${distance}px`);
            
            document.body.appendChild(beam);
            
            // 动画结束后移除元素
            setTimeout(() => {
                beam.remove();
            }, 1200);
        }
        
        // 创建音符弹幕 - 从角色位置发射
        function createNoteDanmaku() {
            const now = Date.now();
            if (now - STATE.lastNoteDanmakuTime < 300) return; // 0.3秒冷却
            
            STATE.lastNoteDanmakuTime = now;
            
            const notes = ['♪', '♫', '♩', '♬', '🎵', '🎶'];
            const colors = ['#ff7bac', '#70d7ff', '#b983ff', '#ffd670', '#7bff7b', '#ffdd7b'];
            
            // 从角色位置发射
            const characterRect = DOM.character.getBoundingClientRect();
            const charX = characterRect.left + characterRect.width / 2;
            const charY = characterRect.top + characterRect.height / 2;
            
            for (let i = 0; i < 5; i++) {
                const note = document.createElement('div');
                note.className = 'note-danmaku';
                note.textContent = notes[Math.floor(Math.random() * notes.length)];
                note.style.color = colors[Math.floor(Math.random() * colors.length)];
                note.style.left = `${charX + (Math.random() - 0.5) * 100}px`;
                note.style.top = `${charY + (Math.random() - 0.5) * 80}px`;
                
                // 随机方向
                const angle = Math.random() * Math.PI * 2;
                const distance = 200 + Math.random() * 300;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                note.style.setProperty('--tx', `${tx}px`);
                note.style.setProperty('--ty', `${ty}px`);
                
                document.body.appendChild(note);
                
                // 动画结束后移除元素
                setTimeout(() => {
                    if (note.parentNode) {
                        note.remove();
                    }
                }, 1500);
            }
        }
        
        // 创建星光特效
        function createStarlight() {
            if (!STATE.isZenMode || !STATE.zenEffectsActive) return;
            
            const star = document.createElement('div');
            star.className = 'starlight';
            star.style.left = `${Math.random() * window.innerWidth}px`;
            star.style.top = `${Math.random() * window.innerHeight}px`;
            star.style.color = `#${Math.floor(Math.random()*16777215).toString(16)}`;
            star.style.fontSize = `${Math.random() * 40 + 20}px`;
            star.innerHTML = '★';
            
            document.body.appendChild(star);
            
            // 动画结束后移除元素
            setTimeout(() => {
                if (star.parentNode) {
                    star.remove();
                }
            }, 1000);
        }
        
        // 创建莫比乌斯环
        function createMobiusRing() {
            // 只在Zen模式下显示莫比乌斯环
            if (!STATE.isZenMode || !STATE.zenEffectsActive) {
                DOM.mobiusRing.style.display = 'none';
                return;
            }
            
            DOM.mobiusRing.innerHTML = '';
            
            const dotCount = 15;
            for (let i = 0; i < dotCount; i++) {
                const dot = document.createElement('div');
                dot.className = 'mobius-dot';
                dot.style.animationDelay = `${i * (5000 / dotCount)}ms`;
                DOM.mobiusRing.appendChild(dot);
            }
            
            // 显示
            DOM.mobiusRing.style.display = 'block';
            DOM.mobiusRing.style.opacity = '1';
            
            // 动画持续时间是5秒，等待6秒后淡出
            setTimeout(() => {
                // 淡出动画
                DOM.mobiusRing.style.transition = 'opacity 1s';
                DOM.mobiusRing.style.opacity = '0';
                
                // 完全透明后清除内容并隐藏
                setTimeout(() => {
                    DOM.mobiusRing.innerHTML = '';
                    DOM.mobiusRing.style.display = 'none';
                }, 1000);
            }, 6000);
        }
        
        // 每隔一段时间重新创建
        setInterval(() => {
            createMobiusRing();
        }, 8000); // 每8秒一次：5秒动画 + 1秒停留 + 1秒淡出 + 1秒间隔
        
        // 绘制波形图
        function drawWaveform(ctx, canvas, dataArray) {
            ctx.fillStyle = 'rgba(20, 10, 40, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.lineWidth = canvas === DOM.waveformModalCanvas ? 4 : 3;
            ctx.strokeStyle = '#b983ff';
            ctx.beginPath();
            
            const sliceWidth = canvas.width / dataArray.length;
            let x = 0;
            const centerY = canvas.height / 2;
            
            for (let i = 0; i < dataArray.length; i++) {
                const v = dataArray[i] / 128.0 - 1;
                const y = v * (canvas.height / 2) + centerY;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                x += sliceWidth;
            }
            
            ctx.stroke();
        }
        
        // 绘制瀑布图
        function drawWaterfall(ctx, canvas, dataStore, freqData) {
            // 添加新数据行（在底部）
            const newRow = Array(Math.floor(canvas.width * OPTIMIZATION.WATERFALL_RESOLUTION)).fill(0);
            for (let i = 0; i < newRow.length; i++) {
                const freqIndex = Math.floor(i * freqData.length / newRow.length);
                newRow[i] = freqData[freqIndex];
            }
            
            dataStore.push(newRow);
            
            // 保持数据长度不超过画布高度
            if (dataStore.length > canvas.height) {
                dataStore.shift();
            }
            
            // 绘制瀑布图
            const imageData = ctx.createImageData(canvas.width, canvas.height);
            
            for (let y = 0; y < canvas.height; y++) {
                if (y >= dataStore.length) break;
                
                const row = dataStore[y];
                for (let x = 0; x < canvas.width; x++) {
                    const value = row[Math.floor(x / canvas.width * row.length)];
                    const index = (y * canvas.width + x) * 4;
                    
                    // 使用三月七配色
                    const r = Math.min(255, 112 + value);
                    const g = Math.min(255, 215 - value * 0.5); 
                    const b = Math.min(255, 255 - value * 0.3);
                    
                    imageData.data[index] = r;
                    imageData.data[index + 1] = g;
                    imageData.data[index + 2] = b;
                    imageData.data[index + 3] = 230;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        // 绘制左右柱状频谱
        function drawBars(freqData) {
            const barWidth = DOM.leftBarCanvas.width / 2;
            const barSpacing = 2;
            const maxBars = 64;
            const barHeightMultiplier = 2.5;
            
            // 绘制左侧柱状图
            CTX.leftBar.clearRect(0, 0, DOM.leftBarCanvas.width, DOM.leftBarCanvas.height);
            for (let i = 0; i < maxBars; i++) {
                const barIndex = Math.floor(i * freqData.length / maxBars);
                const value = freqData[barIndex];
                const barHeight = value * barHeightMultiplier;
                
                const x = DOM.leftBarCanvas.width / 2 - barWidth / 2;
                const y = DOM.leftBarCanvas.height - (i * (barHeight + barSpacing));
                
                const gradient = CTX.leftBar.createLinearGradient(x, y, x, y - barHeight);
                gradient.addColorStop(0, '#ff7bac');
                gradient.addColorStop(0.5, '#70d7ff');
                gradient.addColorStop(1, '#b983ff');
                
                CTX.leftBar.fillStyle = gradient;
                CTX.leftBar.fillRect(x, y, barWidth, -barHeight);
                
                CTX.leftBar.shadowColor = '#b983ff';
                CTX.leftBar.shadowBlur = 10;
                CTX.leftBar.fillRect(x, y, barWidth, -barHeight);
                CTX.leftBar.shadowBlur = 0;
            }
            
            // 绘制右侧柱状图
            CTX.rightBar.clearRect(0, 0, DOM.rightBarCanvas.width, DOM.rightBarCanvas.height);
            for (let i = 0; i < maxBars; i++) {
                const barIndex = Math.floor(i * freqData.length / maxBars);
                const value = freqData[barIndex];
                const barHeight = value * barHeightMultiplier;
                
                const x = 0;
                const y = DOM.rightBarCanvas.height - (i * (barHeight + barSpacing));
                
                const gradient = CTX.rightBar.createLinearGradient(x, y, x, y - barHeight);
                gradient.addColorStop(0, '#ff7bac');
                gradient.addColorStop(0.5, '#70d7ff');
                gradient.addColorStop(1, '#b983ff');
                
                CTX.rightBar.fillStyle = gradient;
                CTX.rightBar.fillRect(x, y, barWidth, -barHeight);
                
                CTX.rightBar.shadowColor = '#b983ff';
                CTX.rightBar.shadowBlur = 10;
                CTX.rightBar.fillRect(x, y, barWidth, -barHeight);
                CTX.rightBar.shadowBlur = 0;
            }
        }
        
        // 绘制圆环频谱
        function drawCircleSpectrum(freqData) {
            const canvas = document.createElement('canvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const ctx = canvas.getContext('2d');
            
            DOM.circleSpectrum.innerHTML = '';
            DOM.circleSpectrum.appendChild(canvas);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) * 0.4;
            const bars = 180;
            const barWidth = 2;
            
            ctx.shadowBlur = 15;
            
            // 计算平均音量用于角色跳舞
            let sum = 0;
            for (let i = 0; i < freqData.length; i++) {
                sum += freqData[i];
            }
            const avgVolume = sum / freqData.length;
            
            // 角色跳舞动画
            if (STATE.isPlaying && avgVolume > 50) {
                DOM.character.style.animation = `dance ${600 - avgVolume/2}ms infinite`;
                DOM.character.style.animationTimingFunction = 'ease-in-out';
            }
            
            // 在Zen模式下创建螺旋弹幕
            if (STATE.isZenMode && STATE.isPlaying) {
                const volume = detectBeat(freqData);
                createSpiralDanmaku(volume);
                
                // 创建星光特效
                if (STATE.zenEffectsActive && Math.random() < 0.3) {
                    createStarlight();
                }
            }
            
            // 绘制3D背景
            ctx.fillStyle = 'rgba(26, 10, 46, 0.3)';
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 1.2, 0, Math.PI * 2);
            ctx.fill();
            
            // 添加3D效果
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(Math.PI / 4);
            ctx.translate(-centerX, -centerY);
            
            for (let i = 0; i < bars; i++) {
                const angle = (i * Math.PI * 2) / bars - Math.PI / 2;
                const barIndex = Math.floor(i * freqData.length / bars);
                const value = freqData[barIndex];
                
                const barLength = (value / 256) * (radius * 0.7);
                const startX = centerX + Math.cos(angle) * radius;
                const startY = centerY + Math.sin(angle) * radius;
                const endX = centerX + Math.cos(angle) * (radius + barLength);
                const endY = centerY + Math.sin(angle) * (radius + barLength);
                
                const gradient = ctx.createLinearGradient(startX, startY, endX, endY);
                gradient.addColorStop(0, '#ff7bac');
                gradient.addColorStop(0.5, '#70d7ff');
                gradient.addColorStop(1, '#b983ff');
                
                ctx.shadowColor = i % 3 === 0 ? '#ff7bac' : i % 3 === 1 ? '#70d7ff' : '#b983ff';
                
                ctx.beginPath();
                ctx.lineWidth = barWidth;
                ctx.lineCap = 'round';
                ctx.strokeStyle = gradient;
                ctx.moveTo(startX, startY);
                ctx.lineTo(endX, endY);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.fillStyle = '#b983ff';
                ctx.arc(endX, endY, barWidth * 1.5, 0, Math.PI * 2);
                ctx.fill();
                
                // 创建粒子效果
                if (value > 200 && Math.random() > 0.7 && particles.length < OPTIMIZATION.MAX_PARTICLES) {
                    createParticle(endX, endY, i % 3 === 0 ? '#ff7bac' : i % 3 === 1 ? '#70d7ff' : '#b983ff');
                }
            }
            
            ctx.restore();
            
            // 绘制中心圆
            ctx.beginPath();
            ctx.fillStyle = 'rgba(26, 10, 46, 0.7)';
            ctx.arc(centerX, centerY, radius * 0.3, 0, Math.PI * 2);
            ctx.fill();
            
            // 绘制内圆
            ctx.beginPath();
            ctx.fillStyle = 'rgba(255, 123, 172, 0.2)';
            ctx.arc(centerX, centerY, radius * 0.15, 0, Math.PI * 2);
            ctx.fill();
            
            // 添加3D高光
            ctx.beginPath();
            ctx.arc(centerX - radius * 0.1, centerY - radius * 0.1, radius * 0.12, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.fill();
            
            ctx.shadowBlur = 0;
            
            // 递归调用以持续更新
            if (STATE.isPlaying) {
                STATE.circleSpectrumAnimationId = requestAnimationFrame(() => {
                    STATE.analyser.getByteFrequencyData(freqData);
                    drawCircleSpectrum(freqData);
                });
            }
        }
        
        // ===================== 粒子系统 =====================
        // 创建粒子
        function createParticle(x, y, color) {
            let particle;
            
            // 使用对象池
            if (particlePool.length > 0) {
                particle = particlePool.pop();
                particle.x = x;
                particle.y = y;
                particle.color = color;
                particle.size = Math.random() * 8 + 2;
                particle.opacity = Math.random() * 0.6 + 0.2;
                particle.life = Math.random() * 2000 + 1000;
                particle.angle = Math.random() * Math.PI * 2;
                particle.speed = Math.random() * 2 + 1;
                particle.active = true;
            } else {
                particle = {
                    x, y, color,
                    size: Math.random() * 8 + 2,
                    opacity: Math.random() * 0.6 + 0.2,
                    life: Math.random() * 2000 + 1000,
                    angle: Math.random() * Math.PI * 2,
                    speed: Math.random() * 2 + 1,
                    active: true
                };
            }
            
            particles.push(particle);
            return particle;
        }
        
        // 绘制粒子
        function drawParticles() {
            // 清除画布
            CTX.particles.clearRect(0, 0, DOM.particlesCanvas.width, DOM.particlesCanvas.height);
            
            // 更新并绘制粒子
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                
                p.x += Math.cos(p.angle) * p.speed;
                p.y += Math.sin(p.angle) * p.speed;
                p.opacity -= 0.005;
                
                if (p.opacity <= 0 || p.life <= 0) {
                    // 回收粒子
                    p.active = false;
                    particlePool.push(particles.splice(i, 1)[0]);
                    continue;
                }
                
                p.life -= 1000 / OPTIMIZATION.VISUALIZATION_FPS;
                
                // 绘制粒子
                CTX.particles.beginPath();
                CTX.particles.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                CTX.particles.fillStyle = `rgba(${hexToRgb(p.color)}, ${p.opacity})`;
                CTX.particles.fill();
            }
        }
        
        // 创建初始粒子效果
        function createInitialParticles() {
            for (let i = 0; i < 30; i++) {
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * window.innerHeight;
                const colors = ['#ff7bac', '#70d7ff', '#b983ff'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                createParticle(x, y, color);
            }
        }
        
        // ===================== 弹幕系统 =====================
        // 创建螺旋弹幕
        function createSpiralDanmaku(volume) {
            if (!STATE.isZenMode || !STATE.isPlaying) return;
            if (volume < 0.3) return;
            
            // 检查弹幕是否启用
            if (!DANMAKU_SETTINGS.enabled) return;
            
            const now = Date.now();
            
            // 应用频率设置
            const frequencyThreshold = 1000 * (1 - DANMAKU_SETTINGS.frequency);
            if (now - STATE.lastDanmakuTime < frequencyThreshold) return;
            
            STATE.lastDanmakuTime = now;
            
            // 应用速度设置
            const animationDuration = 1.5 / DANMAKU_SETTINGS.speed;
            
            const danmakuCount = Math.min(Math.floor(volume * 8) + 5, OPTIMIZATION.MAX_DANMAKU);
            
            for (let i = 0; i < danmakuCount; i++) {
                const types = ['❄️', '★', '✨', '♪', '♫', '♩', '♬', '🎵', '🎶', '🚀', '🌌', '⭐', '🌠', '💫', '🌀'];
                const colors = ['#ff7bac', '#70d7ff', '#b983ff', '#ffd670', '#ff7b7b', '#7bff7b', '#ffdd7b'];
                const size = Math.random() * 30 + 20;
                const type = types[Math.floor(Math.random() * types.length)];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                const danmaku = document.createElement('div');
                danmaku.className = 'danmaku';
                danmaku.innerHTML = type;
                danmaku.style.color = color;
                danmaku.style.fontSize = `${size}px`;
                
                if (volume > 0.5) {
                    danmaku.style.animation = 'pulse 0.2s ease';
                }
                
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                danmaku.style.left = `${centerX}px`;
                danmaku.style.top = `${centerY}px`;
                
                const distance = 600 + Math.random() * 400;
                const angle = STATE.spiralAngle + (i * (Math.PI * 2) / danmakuCount);
                
                STATE.spiralAngle += 0.1;
                if (STATE.spiralAngle > Math.PI * 2) STATE.spiralAngle = 0;
                
                const endX = Math.cos(angle) * distance;
                const endY = Math.sin(angle) * distance;
                
                danmaku.style.setProperty('--tx', `${endX}px`);
                danmaku.style.setProperty('--ty', `${endY}px`);
                danmaku.style.setProperty('--distance', `${distance}px`);
                danmaku.style.animation = `danmakuMove ${animationDuration}s linear forwards`;
                
                document.body.appendChild(danmaku);
                
                setTimeout(() => {
                    if (danmaku.parentNode) {
                        danmaku.remove();
                    }
                }, animationDuration * 1000);
            }
        }
        
        // 检测鼓点
        function detectBeat(freqData) {
            if (!STATE.audioElement) return 0;
            
            STATE.analyser.getByteFrequencyData(STATE.lowFrequencyData);
            
            let bassEnergy = 0;
            const bassBins = 10;
            for (let i = 0; i < bassBins; i++) {
                bassEnergy += STATE.lowFrequencyData[i];
            }
            bassEnergy /= bassBins;
            
            const currentTime = Date.now();
            if (bassEnergy > 180 && currentTime - STATE.lastBeatTime > STATE.beatInterval * 0.5) {
                STATE.lastBeatTime = currentTime;
                STATE.beatInterval = Math.max(100, Math.min(800, STATE.beatInterval * 0.9 + (currentTime - STATE.lastBeatTime) * 0.1));
            }
            
            return bassEnergy / 256;
        }
        
        // ===================== 工具函数 =====================
        // 格式化时间
        function formatTime(seconds) {
            if (isNaN(seconds)) return "0:00";
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }
        
        // 更新进度条
        function updateProgress() {
            if (!STATE.audioElement) return;
            
            const percent = (STATE.audioElement.currentTime / STATE.audioElement.duration) * 100;
            DOM.progressFill.style.width = `${percent}%`;
            DOM.currentTimeEl.textContent = formatTime(STATE.audioElement.currentTime);
        }
        
        // 更新音量填充
        function updateVolumeFill() {
            DOM.volumeFill.style.width = `${STATE.audioElement ? STATE.audioElement.volume * 100 : DOM.volumeSlider.value * 100}%`;
        }
        
        // 调整Canvas大小
        function resizeCanvas() {
            DOM.waveformCanvas.width = DOM.waveformCanvas.clientWidth;
            DOM.waveformCanvas.height = DOM.waveformCanvas.clientHeight;
            DOM.waterfallCanvas.width = DOM.waterfallCanvas.clientWidth;
            DOM.waterfallCanvas.height = DOM.waterfallCanvas.clientHeight;
            
            DOM.leftBarCanvas.width = DOM.leftBarCanvas.clientWidth;
            DOM.leftBarCanvas.height = window.innerHeight;
            DOM.rightBarCanvas.width = DOM.rightBarCanvas.clientWidth;
            DOM.rightBarCanvas.height = window.innerHeight;
            
            DOM.waveformModalCanvas.width = DOM.waveformModalCanvas.clientWidth;
            DOM.waveformModalCanvas.height = DOM.waveformModalCanvas.clientHeight;
            DOM.waterfallModalCanvas.width = DOM.waterfallModalCanvas.clientWidth;
            DOM.waterfallModalCanvas.height = DOM.waterfallModalCanvas.clientHeight;
            
            DOM.particlesCanvas.width = window.innerWidth;
            DOM.particlesCanvas.height = window.innerHeight;
            
            waterfallData = Array(waterfallHeight).fill().map(() => 
                Array(Math.floor(DOM.waterfallCanvas.width * OPTIMIZATION.WATERFALL_RESOLUTION)).fill(0)
            );
            
            waterfallModalData = Array(waterfallHeight).fill().map(() => 
                Array(Math.floor(DOM.waterfallModalCanvas.width * OPTIMIZATION.WATERFALL_RESOLUTION)).fill(0)
            );
        }
        
        // 清除Canvas
        function clearCanvas() {
            CTX.waveform.clearRect(0, 0, DOM.waveformCanvas.width, DOM.waveformCanvas.height);
            CTX.waterfall.clearRect(0, 0, DOM.waterfallCanvas.width, DOM.waterfallCanvas.height);
            CTX.leftBar.clearRect(0, 0, DOM.leftBarCanvas.width, DOM.leftBarCanvas.height);
            CTX.rightBar.clearRect(0, 0, DOM.rightBarCanvas.width, DOM.rightBarCanvas.height);
        }
        
        // 重置可视化数据
        function resetVisualizations() {
            waterfallData = Array(waterfallHeight).fill().map(() => 
                Array(Math.floor(DOM.waterfallCanvas.width * OPTIMIZATION.WATERFALL_RESOLUTION)).fill(0)
            );
        }
        
        // 停止所有可视化
        function stopVisualizations() {
            if (STATE.visualizationId) {
                cancelAnimationFrame(STATE.visualizationId);
                STATE.visualizationId = null;
            }
            if (STATE.circleSpectrumAnimationId) {
                cancelAnimationFrame(STATE.circleSpectrumAnimationId);
                STATE.circleSpectrumAnimationId = null;
            }
            if (STATE.updateProgressId) {
                clearInterval(STATE.updateProgressId);
                STATE.updateProgressId = null;
            }
        }
        
        // 释放音频资源
        function releaseAudioResources() {
            if (STATE.source) {
                STATE.source.disconnect();
                STATE.source = null;
            }
            if (STATE.audioElement) {
                STATE.audioElement.pause();
                STATE.audioElement.src = "";
                STATE.audioElement = null;
            }
        }
        
        // 切换Zen模式
        function toggleZenMode() {
            STATE.isZenMode = !STATE.isZenMode;
            
            if (STATE.isZenMode) {
                document.body.classList.add('zen-mode');
                DOM.zenToggle.innerHTML = '<i class="fas fa-compress"></i> 退出Zen模式';
                
                // 确保频谱和弹幕显示在最上层
                const circleSpectrum = document.querySelector('.circle-spectrum');
                if (circleSpectrum) {
                    circleSpectrum.style.zIndex = '300';
                }
                
                // 确保弹幕显示在最上层
                const danmakuElements = document.querySelectorAll('.danmaku');
                danmakuElements.forEach(el => {
                    el.style.zIndex = '400';
                });
                
                // 3秒后激活额外特效
                setTimeout(() => {
                    STATE.zenEffectsActive = true;
                    createMobiusRing();
                }, 3000);
            } else {
                document.body.classList.remove('zen-mode');
                DOM.zenToggle.innerHTML = '<i class="fas fa-expand"></i> Zen模式';
                
                // 退出时重置圆环频谱z-index
                DOM.circleSpectrum.style.zIndex = '0';
                STATE.zenEffectsActive = false;
                DOM.mobiusRing.style.display = 'none';
            }
        }
        
        // 处理背景上传
        function handleBgUpload(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    DOM.bgOverlay.style.backgroundImage = `url(${event.target.result})`;
                    if (!STATE.customCover) {
                        DOM.albumArt.src = event.target.result;
                    }
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        // 重置背景设置
        function clearBackground() {
            DOM.bgOverlay.style.backgroundImage = `url(${STATE.defaultBg})`;
            DOM.albumArt.src = 'https://patchwiki.biligame.com/images/sr/thumb/2/2e/d92nzv261q5e18sec93pfzie8kdjaok.png/330px-%E5%BC%80%E6%9C%8D%E5%80%92%E8%AE%A1%E6%97%B6-%E4%B8%89%E6%9C%88%E4%B8%83.png';
            DOM.bgFileInput.value = ''; // 修复重置后无法上传相同图片的问题
        }
        
        // 处理角色上传
        function handleCharUpload(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    STATE.customCharUrl = event.target.result;
                    DOM.character.style.backgroundImage = `url(${STATE.customCharUrl})`;
                    DOM.character.style.display = 'block';
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        // 重置角色设置
        function clearCharacter() {
            DOM.character.style.backgroundImage = `url(${STATE.defaultChar})`;
            DOM.charFileInput.value = ''; // 修复重置后无法上传相同图片的问题
        }
        
        // 处理抢镜头像上传
        function handleBombUpload(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    STATE.customBombUrl = event.target.result;
                    updateBombImages();
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        // 更新所有抢镜头像
        function updateBombImages() {
            const bombImages = document.querySelectorAll('.photo-bomb img');
            bombImages.forEach(img => {
                img.src = STATE.customBombUrl;
            });
        }
        
        // 重置抢镜头像
        function resetBombImage() {
            STATE.customBombUrl = null;
            const bombImages = document.querySelectorAll('.photo-bomb img');
            bombImages.forEach(img => {
                img.src = 'https://patchwiki.biligame.com/images/sr/thumb/2/2e/d92nzv261q5e18sec93pfzie8kdjaok.png/330px-%E5%BC%80%E6%9C%8D%E5%80%92%E8%AE%A1%E6%97%B6-%E4%B8%89%E6%9C%88%E4%B8%83.png';
            });
            DOM.bombFileInput.value = ''; // 修复重置后无法上传相同图片的问题
        }
        
        // 处理封面上传
        function handleCoverUpload(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    STATE.customCover = event.target.result;
                    DOM.albumArt.src = STATE.customCover;
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        // 更新背景透明度
        function updateBgOpacity() {
            const opacity = DOM.bgOpacitySlider.value / 100;
            DOM.bgOverlay.style.opacity = opacity;
        }
        
        // 更新角色透明度
        function updateCharOpacity() {
            const opacity = DOM.charOpacitySlider.value / 100;
            DOM.character.style.opacity = opacity;
        }
        
        // 更新音量
        function updateVolume() {
            if (STATE.audioElement) {
                STATE.audioElement.volume = DOM.volumeSlider.value;
            }
            updateVolumeFill();
        }
        
        // 更新进度位置
        function updateProgressPosition(e) {
            if (!STATE.audioElement) return;
            
            const rect = DOM.progressBar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            STATE.audioElement.currentTime = STATE.audioElement.duration * percent;
            DOM.progressFill.style.width = `${percent * 100}%`;
            updateProgress();
        }
        
        // 打开模态框
        function openModal(modal) {
            modal.style.display = 'flex';
            resizeCanvas();
        }
        
        // 关闭模态框
        function closeModal(modal) {
            modal.style.display = 'none';
            if (modal === DOM.waterfallModal) {
                waterfallModalData = Array(waterfallHeight).fill().map(() => 
                    Array(Math.floor(DOM.waterfallModalCanvas.width * OPTIMIZATION.WATERFALL_RESOLUTION)).fill(0)
                );
            }
        }
        
        // 清理资源
        function cleanup() {
            releaseAudioResources();
            stopVisualizations();
            
            // 取消所有动画帧
            cancelAnimationFrame(STATE.visualizationId);
            cancelAnimationFrame(STATE.circleSpectrumAnimationId);
            
            // 清除粒子
            particles = [];
            particlePool = [];
        }
        
        // 辅助函数：十六进制颜色转RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? 
                `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : 
                '255, 123, 172';
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
